# atom2reMarkable

An automated Python application that converts Atom XML feeds into PDF documents and uploads them to reMarkable Cloud. Designed to run as an automated 

## Features

- **Recent Content Only**: Processes only entries from the last 24 hours
- **Multiple Feed Support**: Reads feed URLs from a `feeds.txt` file
- **Templated PDF output**: PDF output styled with HTML and CSS template
- **Comprehensive Logging**: Detailed logs with statistics and error tracking
- **Docker Support**: Containerized deployment

## Quick Start

### Authentication

The reMarkable API requires a device token, which can only be created by providing a one-time code generated by the reMarkable website. Once that token is generated, it can be persisted and is used to generate user tokens.

This app expects a $DEVICE_TOKEN environment variable to exist, containing the value of that token.

As this project is intended to run in ephemeral containers, we need to generate a token outside of the app and persist it elsewhere. Running it in container action in GitHub Actions gives us access to repository secrets and the ability to pass them as environment variables to the container.

But, first we need to generate the token. For that, there's a helper script provided called `TOKEN_RETRIEVER.sh`. It's a bit of a hack, but one that only needs to be run once.

**Using TOKEN_RETRIEVER.sh**
1. Install the app locally by cloning the repo and following the instructions below
2. Perform an initial run of `rmapi`
3. Follow the authentication instructions
4. Run `./TOKEN_RETRIEVER.sh` in your shell
5. Create a `DEVICE_TOKEN` repository secret or environment variable and assign it the output of step 4
   

### Local Installation

1. **Install dependencies:**
```bash
pip install -r requirements.txt
```

2. **Configure feeds:**
Edit `feeds.txt` to include your Atom feed URLs (one per line):
```
https://realpython.com/atom.xml
https://feeds.feedburner.com/oreilly/radar
https://planet.python.org/rss20.xml
```

3. **Run once:**
```bash
python main.py
```

### Docker Deployment

**Build and run:**
```bash
# Build the image
docker build -t atom2remarkable .

# Run with your .env file (contains DEVICE_TOKEN)
docker run --rm --env-file .env atom2remarkable
```

**Or use the provided script:**
```bash
./run.sh
```

The Docker container is completely self-contained and includes:
- All dependencies pre-installed
- rmapi binary for reMarkable Cloud integration
- Automatic rmapi configuration from environment variables
- All necessary environment variables with sensible defaults

**Required setup:**
1. Create a `.env` file with your reMarkable device token:
   ```
   DEVICE_TOKEN="your_remarkable_device_token_here"
   ```
2. Run the container - it will automatically upload PDFs to your reMarkable device

### GitHub Actions Deployment

The application includes a GitHub Actions workflow that:
- Runs daily at 6:00 AM UTC
- Can be triggered manually with custom parameters
- Generates PDFs inside the container
- Automatically uploads to reMarkable Cloud
- Extracts and uploads results as artifacts

**Setup:**
1. Push this repository to GitHub
2. Add your `DEVICE_TOKEN` as a repository secret
3. The workflow is automatically configured in `.github/workflows/atom-feed-processor.yml`
4. PDFs will be uploaded to your reMarkable device and available as downloadable artifacts

**Manual trigger:**
- Go to Actions tab in your GitHub repository
- Select "Atom Feed Processor" workflow
- Click "Run workflow" to process feeds immediately
docker run --rm \
  -v "$(pwd)/output:/app/output" \
  -v "$(pwd)/logs:/app/logs" \
  atom2remarkable
```

**Run with custom parameters:**
```bash
docker run --rm \
  -v "$(pwd)/output:/app/output" \
  -v "$(pwd)/logs:/app/logs" \
  -e RECENT_HOURS=48 \
  atom2remarkable
```

## Configuration

### Environment Variables

- `FEEDS_FILE`: Path to feeds list file (default: `feeds.txt`)
- `OUTPUT_DIR`: Directory for generated PDFs (default: `output`)
- `LOG_DIR`: Directory for log files (default: `logs`)
- `RECENT_HOURS`: Hours to look back for recent entries (default: `24`)
- `REQUEST_TIMEOUT`: HTTP request timeout in seconds (default: `30`)

#### reMarkable Cloud Integration

- `DEVICE_TOKEN`: Your reMarkable device token (required for upload)
- `REMARKABLE_FOLDER`: Folder name in reMarkable Cloud (default: `AtomFeeds`)

### Command Line Options

```bash
python main.py [OPTIONS]

Options:
  --feeds-file PATH        Override feeds.txt file location
  --output-dir PATH        Override output directory
  --recent-hours INT       Override recent entry window
  --remarkable-folder NAME reMarkable folder name
  --rmapi-path PATH        Path to rmapi binary
```

## reMarkable Cloud Integration

The application automatically uploads generated PDFs to your reMarkable Cloud account. No additional setup or rmapi installation is required when using Docker.

### Setup

**For Docker (recommended):**
1. **Get your device token:**
   - Visit [my.remarkable.com](https://my.remarkable.com)
   - Go to Desktop app settings
   - Generate a new device token

2. **Create .env file:**
   ```bash
   echo 'DEVICE_TOKEN="your_token_here"' > .env
   ```

3. **Run the application:**
   ```bash
   docker run --rm --env-file .env atom2remarkable
   ```

**For local installation:**
1. **Install rmapi locally:**
   ```bash
   # Download latest release from GitHub
   wget https://github.com/ddvk/rmapi/releases/latest/download/rmapi-linuxx86-64.tar.gz
   tar -xzf rmapi-linuxx86-64.tar.gz
   sudo mv rmapi /usr/local/bin/
   ```

2. **Authenticate with reMarkable Cloud:**
   ```bash
   rmapi
   # Follow prompts to connect your reMarkable account
   ```

3. **Run with reMarkable upload:**
   ```bash
   python main.py
   ```

### Features

- **Automatic organization**: PDFs are organized into subfolders by feed name
- **Custom folder**: Configure target folder name (default: `AtomFeeds`)
- **Local cleanup**: Option to delete local PDFs after successful upload
- **Error handling**: Failed uploads are logged and retried on next run
- **Token-based authentication**: Simple device token setup, no complex authentication flow

### Docker Integration

The Docker image includes rmapi pre-installed and handles authentication automatically:

```bash
# Create .env file with your device token
echo 'DEVICE_TOKEN="your_token_here"' > .env

# Run - PDFs will be automatically uploaded
docker run --rm --env-file .env atom2remarkable
```

## Feed Configuration

Create a `feeds.txt` file with one feed URL per line:

```
# Technology feeds
https://realpython.com/atom.xml
https://feeds.feedburner.com/oreilly/radar

# News feeds  
https://feeds.feedburner.com/tweakers/mixed

# Comments starting with # are ignored
# Blank lines are ignored
```

## Output

### PDF Files

PDFs are organized into subdirectories by feed name, with publication date and article titles as filenames:
```
output/
├── Feed Name 1/
│   ├── MM-DD-YYYY Article Title 1.pdf
│   ├── MM-DD-YYYY Article Title 2.pdf
│   └── MM-DD-YYYY Another Article Title.pdf
└── Feed Name 2/
    ├── MM-DD-YYYY Different Article.pdf
    └── MM-DD-YYYY Some Other Article.pdf
```

Example: `output/Real Python/07-28-2025 Pythons asyncio A Hands-On Walkthrough.pdf`

If duplicate article titles exist within the same feed on the same date, a counter is appended (e.g., `07-30-2025 Article Title.pdf`, `07-30-2025 Article Title 1.pdf`).

### Logs

Daily log files include:
- Processing statistics
- Error details
- Feed parsing status
- PDF generation results

Example log location: `logs/atom_processor_20250730.log`

## PDF Styling

Generated PDFs feature:
- Professional typography (Georgia serif font)
- Proper page breaks and margins
- Metadata headers with feed info and publication date
- Clean HTML content rendering
- Responsive images and tables
- Syntax highlighting for code blocks

## Automation

### Automated Scheduling

For automated daily execution, use cron or GitHub Actions:

```bash
# Add to crontab for daily 6 AM execution
0 6 * * * cd /path/to/app && python main.py
```

## Error Handling

The application handles various error conditions gracefully:

- **Network timeouts**: Skips failed feeds, continues with others
- **Malformed feeds**: Attempts parsing with warnings
- **Missing content**: Handles entries without content gracefully
- **PDF generation failures**: Logs errors, continues processing
- **File system issues**: Creates directories as needed

## Testing

### Comprehensive Testing
Run the consolidated test script to verify all functionality:

```bash
python test.py
```

The test suite includes:
- **Directory Structure**: Verifies all required directories and files exist
- **CSS Loading**: Tests external CSS file loading and configuration
- **Recent Filtering**: Tests date-based entry filtering logic
- **reMarkable Integration**: Tests rmapi availability and folder setup
- **Feed Processing**: Processes a sample feed and generates PDFs

The script provides clear pass/fail results for each test component and an overall summary.
- Displays processing results and logs

Results are saved to `ci-output/` and `ci-logs/` directories.

## Directory Structure

```
atom2remarkable/
├── main.py              # Main application
├── config.py            # Configuration settings
├── feeds.txt            # Feed URLs (one per line)
├── requirements.txt     # Python dependencies
├── Dockerfile           # Container configuration
├── run.sh               # Docker build and run script
├── test.py              # Test script
├── templates/
│   ├── article.html     # PDF template
│   └── style.css        # PDF styling (CSS)
├── output/              # Generated PDFs
└── logs/                # Application logs
```

## System Requirements

### Local Installation
- Python 3.8+
- System libraries for WeasyPrint (automatically handled in Docker)

### Docker Installation
- Docker

## Example Usage Scenarios

### Personal News Digest
```bash
# Process tech news feeds (set up as daily cron job)
python main.py
```

### Research Paper Updates
```bash
# Check for papers from last 12 hours
python main.py --recent-hours 12
```

### Custom Feed List
```bash
# Use different feed file
python main.py --feeds-file research_feeds.txt --output-dir papers/
```

## Troubleshooting

### Common Issues

1. **No PDFs generated**: Check if feeds have recent entries within the time window
2. **Network errors**: Verify feed URLs are accessible
3. **Permission errors**: Ensure write access to output and log directories
4. **WeasyPrint errors**: Install system dependencies (handled automatically in Docker)

### Debug Mode

Enable verbose logging:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### Feed Validation

Test individual feeds:

```bash
python -c "
import feedparser
feed = feedparser.parse('YOUR_FEED_URL')
print(f'Title: {feed.feed.title}')
print(f'Entries: {len(feed.entries)}')
"
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Submit a pull request

## License

MIT License - see LICENSE file for details.
